// #############################################################################
// *****************************************************************************
//                  Copyright (c) 2007-2009, WiMi-net Corp.
//      THIS IS AN UNPUBLISHED WORK CONTAINING CONFIDENTIAL AND PROPRIETARY
//               INFORMATION WHICH IS THE PROPERTY OF WIMI-NET CORP.
//
//    ANY DISCLOSURE, USE, OR REPRODUCTION, WITHOUT WRITTEN AUTHORIZATION FROM
//                   WIMI-NET CORP., IS STRICTLY PROHIBITED.
// *****************************************************************************
// #############################################################################
//
// File:    api-rxqueue.h
// Author:  Mickle.ding
// Created: 11/2/2011
//
// Description:  Define the class api-rxqueue
// -----------------------------------------------------------------------------


// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#ifndef _API_RX_QUEUE_INC_

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#define _API_RX_QUEUE_INC_

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#include <Windows.h>

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#include "API-Message.h"

// -----------------------------------------------------------------------------
// DESCRIPTION: 接收过程：初始化通讯过程
// -----------------------------------------------------------------------------
#define API_RX_STATUS_INIT                                     0X00

// -----------------------------------------------------------------------------
// DESCRIPTION: 接收过程：接收通讯全局描述符，包括接收方文件的大小和CRC32
// -----------------------------------------------------------------------------
#define API_RX_STATUS_SINF                                     0X01

// -----------------------------------------------------------------------------
// DESCRIPTION: 接收过程：
// -----------------------------------------------------------------------------
#define API_RX_STATUS_RECV                                     0X02

// -----------------------------------------------------------------------------
// DESCRIPTION: 接收过程：打印通讯报告，给出当前的接收状态
// -----------------------------------------------------------------------------
#define API_RX_STATUS_REPT                                     0X03

// -----------------------------------------------------------------------------
// DESCRIPTION: 接收过程：通讯完成
// -----------------------------------------------------------------------------
#define API_RX_STATUS_OVER                                     0X04

// -----------------------------------------------------------------------------
// DESCRIPTION: 接收过程：通讯空闲
// -----------------------------------------------------------------------------
#define API_RX_STATUS_IDLE                                     0X05



// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _RX_TASK_INFO_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char                                                       m_pBuffer[1024*1024];
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwBufferSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwPacketSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwOffsetSize;

   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iTaskPercent;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwCRC32;

   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iHead;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iTail;

   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iSInf;   
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iNode;

   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char																m_iAttribute;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwTaskID;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iStatus; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwOpenTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwRecvTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwThisTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerSpan;   
   
} RxTaskInfo;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _API_RX_QUEUE_STATE_MACHINE_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iMainStatus;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwOpenTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwThisTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerSpan;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_pBuffer[0XFF]; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   NodeMsg *                                                   m_pMsg;   
   
} API_RxQueue_StateMachine;


// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
extern RxTaskInfo  RxTask;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
extern API_RxQueue_StateMachine API_RxQueue;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_SetupRxQueueStateMachine();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_CloseRxQueueStateMachine();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxQueueHandler();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
char API_RxStateHandler_CheckCRC();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
char API_RxStateHandler_InputPkt();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_Init();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_SInf();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_Recv();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_Body();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_Tail();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_Rept();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_Over();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void API_RxStateHandler_Idle();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#endif