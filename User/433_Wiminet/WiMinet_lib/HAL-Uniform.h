// #############################################################################
// *****************************************************************************
//                  Copyright (c) 2007-2009, WiMi-net Corp.
//      THIS IS AN UNPUBLISHED WORK CONTAINING CONFIDENTIAL AND PROPRIETARY
//               INFORMATION WHICH IS THE PROPERTY OF WIMI-NET CORP.
//
//    ANY DISCLOSURE, USE, OR REPRODUCTION, WITHOUT WRITTEN AUTHORIZATION FROM
//                   WIMI-NET CORP., IS STRICTLY PROHIBITED.
// *****************************************************************************
// #############################################################################
//
// File:    hal-uniform.h
// Author:  Mickle.ding
// Created: 1/4/2012
//
// Description:  Define the class hal-uniform
// -----------------------------------------------------------------------------



// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#ifndef _HAL_UNIFORM_INC_

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#define _HAL_UNIFORM_INC_

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#include <list>

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#include <Windows.h>

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#include "API-Message.h"

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#include "API-Queue16.h"

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_IODEVICE_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iPhysicalID;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   HANDLE                                                      m_hFileHandle;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char *                                                      m_pPacketBuff;   
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   AtomicQueue16                                               m_PacketQueue;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_pBuffer[0XFF]; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   NodeMsg *                                                   m_pMsg;   
   
} ShellIODevice;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_MSGQUEUE_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char *                                                      m_pStringBuff;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char *                                                      m_pTxdAckBuff;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char *                                                      m_pRxdPktBuff;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char *                                                      m_pSigPktBuff;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char *                                                      m_pCmdAckBuff;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char *                                                      m_pNetMonBuff;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   AtomicQueue16                                               m_StringQueue;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   AtomicQueue16                                               m_TxdAckQueue;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   AtomicQueue16                                               m_RxdPktQueue;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   AtomicQueue16                                               m_SigPktQueue;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   AtomicQueue16                                               m_CmdAckQueue;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   AtomicQueue16                                               m_NetMonQueue; 
   
} ShellMsgQueue;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_TXDRIVER_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iThisNodeID;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iNodeStatus;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iMainStatus;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iTxUsedSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iTxFreeSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iTxFIFOSize;   
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iTxMemEmpty;   
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwOpenTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwThisTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerSpan;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_pBuffer[0XFF]; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   NodeMsg *                                                   m_pMsg;   
   
} ShellTxDriver;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_TXENGINE_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iMainStatus;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwOpenTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwThisTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerSpan;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_pBuffer[0XFF]; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   NodeMsg *                                                   m_pMsg;   
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   DWORD                                                       m_dwCRC32;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   DWORD                                                       m_dwSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iThisNodeID;
   
   
} ShellTxEngine;


// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_SENDTASK_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char                                                       m_pBuffer[64*1024];
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwBufferSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwPacketSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwOffsetSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwCRC32;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iNode;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iQoS;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwTaskID;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iStatus; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwInitTimer;   
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwOpenTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwSendTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwThisTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerSpan;   
   
} ShellSendTask;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_RXDRIVER_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iState;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerA;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerB;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   
} ShellRxDriver;


// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_RXENGINE_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iMainStatus;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwOpenTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwThisTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerSpan;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_pBuffer[0XFF]; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   NodeMsg *                                                   m_pMsg;   
   
} ShellRxEngine;


// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_RECVTASK_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   char                                                       m_pBuffer[64*1024];
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwBufferSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwPacketSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwOffsetSize;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwCRC32;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iHead;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iTail;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iSInf;   
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned short                                              m_iNode;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned long                                               m_dwTaskID;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   unsigned char                                               m_iStatus; 
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwOpenTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwThisTimer;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ULARGE_INTEGER                                              m_qwTimerSpan;   
   
} ShellRecvTask;


// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _STATUS_MONITOR_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION: 网络节点的状态
   // --------------------------------------------------------------------------
   unsigned char                                               m_iStatus[0XFF];
   
   // --------------------------------------------------------------------------
   // DESCRIPTION: 本节点的工作状态
   // --------------------------------------------------------------------------
   unsigned char                                               m_iWiMode;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:  
   // --------------------------------------------------------------------------
   unsigned short                                              m_iRxNode;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION: 网络参数更新参数掩码
   // --------------------------------------------------------------------------
   unsigned char                                               m_iUpdate;
   
} StatusMonitor;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef struct _SHELL_INSTANCE_
{
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellIODevice                                               m_IODevice;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellMsgQueue                                               m_MsgQueue;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellSendTask                                               m_SendTask;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellRecvTask                                               m_RecvTask;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellTxDriver                                               m_TxDriver;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellRxDriver                                               m_RxDriver;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellTxEngine                                               m_TxEngine;
   
   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   ShellRxEngine                                               m_RxEngine;

   // --------------------------------------------------------------------------
   // DESCRIPTION:
   // --------------------------------------------------------------------------
   StatusMonitor                                               m_SMonitor;

} ShellInstance;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
typedef std::list<ShellInstance>                               ShellQueue;

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellIODevice( ShellIODevice * pIODevice );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellIODevice( ShellIODevice * pIODevice );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellMsgQueue( ShellMsgQueue * pMsgQueue );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellMsgQueue( ShellMsgQueue * pMsgQueue );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellSendTask( ShellSendTask * pSendTask );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellSendTask( ShellSendTask * pSendTask );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellRecvTask( ShellRecvTask * pRecvTask );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellRecvTask( ShellRecvTask * pRecvTask );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellTxDriver( ShellTxDriver * pTxDriver );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellTxDriver( ShellTxDriver * pTxDriver );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellRxDriver( ShellRxDriver * pRxDriver );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellRxDriver( ShellRxDriver * pRxDriver );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellTxEngine( ShellTxEngine * pTxEngine );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellTxEngine( ShellTxEngine * pTxEngine );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellRxEngine( ShellRxEngine * pRxEngine );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellRxEngine( ShellRxEngine * pRxEngine );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitStatusMonitor( StatusMonitor * pSMonitor );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvStatusMonitor( StatusMonitor * pSMonitor );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void InitShellInstance( ShellInstance * pDevShell );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void RemvShellInstance( ShellInstance * pDevShell );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void MallocQueueBuffer( AtomicQueue16 * pQueue, unsigned short iSize );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void DeleteQueueBuffer( AtomicQueue16 * pQueue );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
ShellInstance * CreateUniformShell();

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void DeleteUniformShell( ShellInstance * pDevShell );



// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
void QueryModuleStatus( ShellTxDriver * pTxDriver );

// -----------------------------------------------------------------------------
// DESCRIPTION:
// -----------------------------------------------------------------------------
#endif